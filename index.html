<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trim</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        /* ì „ì²´ ë ˆì´ì•„ì›ƒ (ë¶€íŠ¸ìŠ¤íŠ¸ë©ë§Œìœ¼ë¡  í•œê³„ê°€ ìˆìŒ) */
        body { height: 100vh; overflow: hidden; background-color: #f1f3f5; }
        .page { display: none; height: calc(100vh - 56px); overflow: hidden; }
        .page.active { display: block; }

        /* í…Œì´ë¸” í…ìŠ¤íŠ¸ ìƒëµ (...) ì²˜ë¦¬ - ë¶€íŠ¸ìŠ¤íŠ¸ë©ì— ì—†ëŠ” ê¸°ëŠ¥ */
        #ytTable td { max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .selected-row { background-color: #e9ecef !important; font-weight: bold; }

        /* ìƒì„¸ íŒ¨ë„ ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜ ë° ë„ˆë¹„ ì œì–´ */
        #detailPanel { transition: width 0.3s ease; width: 0; overflow-x: hidden; background: #fff; z-index: 1000; }
        #detailPanel.open { width: 450px; border-left: 1px solid #dee2e6; }
        #detailPanel.expanded { width: 100% !important; }

        /* ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸° (JavaScript ì¢Œí‘œ ê³„ì‚°ìš©) */
        .thumb-preview { position: fixed; z-index: 9999; pointer-events: none; display: none; max-width: 320px; border: 2px solid #fff; }
    </style>
</head>
<body>

    <div class="modal fade" id="loginModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body p-5 text-center">
                    <h3 class="fw-bold mb-3">Trim - YouTube Analyzer</h3>
                    <p class="text-muted mb-4">ì‹¬ì¸µ ë¶„ì„ ê¸°ëŠ¥ì„ ì´ìš©í•˜ì‹œë ¤ë©´<br>êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    <div class="d-grid">
                        <button class="btn btn-dark btn-lg py-3 shadow-sm" onclick="login()">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" class="me-2"> êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°
                        </button>
                    </div>
                    <button type="button" class="btn btn-link btn-sm mt-3 text-decoration-none text-muted" data-bs-dismiss="modal">ë‘˜ëŸ¬ë³´ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <img id="hoverPreview" class="thumb-preview rounded shadow" src="">

    <nav class="navbar navbar-expand-lg py-1 shadow-sm">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <a class="navbar-brand fw-bold me-2" href="#" onclick="showPage('analyzerPage')">TRIM</a>
                <div id="adminBtnArea"></div>
            </div>
            
            <div id="navControls" class="d-flex align-items-center gap-2 flex-grow-1">
                <div class="me-auto"></div> 
                
                <div id="guestControls">
                    <button class="btn btn-warning btn-sm px-3 fw-bold shadow-sm" onclick="new bootstrap.Modal(document.getElementById('loginModal')).show()">
                        ğŸš€ ë¬´ë£Œë¡œ ì´ìš©í•˜ê¸°
                    </button>
                </div>

                <div id="userControls" class="dropdown d-none">
                    <img id="userAvatar" class="avatar-btn dropdown-toggle" data-bs-toggle="dropdown" src="">
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0" id="userMenu">
                        <li><h6 class="dropdown-header" id="userEmailDisplay">ì´ë©”ì¼</h6></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item cursor-pointer" onclick="showPage('profilePage')">ë‚´ ê³„ì • ê´€ë¦¬</a></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div id="analyzerPage" class="page active">
        <div class="filter-bar p-2 px-3 d-flex align-items-center gap-3 flex-wrap">
            <div>
                <label class="search-label">MIN VIEWS</label>
                <input type="number" id="minViews" class="form-control form-control-sm fw-bold text-center" style="width:90px;" value="30000">
            </div>
            <div>
                <label class="search-label">PERIOD</label>
                <select id="monthsAgo" class="form-select form-select-sm">
                    <option value="all">ì „ì²´</option>
                    <option value="1">1ê°œì›”</option>
                    <option value="6" selected>6ê°œì›”</option>
                    <option value="12">1ë…„</option>
                </select>
            </div>
            <div>
                <label class="search-label">TYPE</label>
                <select id="videoType" class="form-select form-select-sm" onchange="toggleTypeDetail()">
                    <option value="any">ì „ì²´</option>
                    <option value="long_form" selected>ë¡±í¼(3ë¶„~)</option>
                    <option value="short_form">ì‡¼ì¸ </option>
                </select>
            </div>
            <div id="typeDetailContainer">
                <label class="search-label">MAX DURATION (ë¶„ ì´í•˜)</label>
                <div class="input-group input-group-sm">
                    <input type="number" id="durationMax" class="form-control" style="width:60px;" value="20">
                    <span class="input-group-text">ë¶„ ì´í•˜</span>
                </div>
            </div>
            <div class="align-self-end">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetToCustomDefaults()" style="font-size: 10px; padding: 2px 8px;">ê¸°ë³¸ê°’</button>
            </div>
            <div class="ms-auto d-flex align-items-center gap-2">
                <input type="text" id="query" class="form-control form-control-sm bg-light" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" style="width: 200px;">
                <button id="searchBtn" class="btn btn-dark btn-sm px-4 fw-bold">ë¶„ì„ ì‹œì‘</button>
            </div>
        </div>

        <div class="d-flex h-100 overflow-hidden">
            <div class="flex-grow-1 overflow-auto p-3">
                <table id="ytTable" class="table table-hover table-sm align-middle w-100">
                    <thead class="table-light">
                        <tr>
                            <th>#</th><th>ì¸ë„¤ì¼</th><th>ì˜ìƒì œëª©</th><th>ë‚ ì§œ</th><th>ì‹œê°„</th><th class="text-end">ì¡°íšŒìˆ˜</th><th class="text-end">ì¢‹ì•„ìš”</th><th class="text-end">ëŒ“ê¸€</th><th>ì¹´í…Œê³ ë¦¬</th><th>ì±„ë„ëª…</th><th class="text-end">êµ¬ë…ì</th><th>íƒœê·¸</th><th>ì„¤ëª…</th><th>ë§í¬</th><th>ê¸¸ì´</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
                <div id="status" class="py-3 text-center text-muted">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
            </div>

            <div id="detailPanel" class="shadow-lg d-flex flex-column">
                <div class="p-4 w-100 d-flex flex-column h-100" style="overflow-y: auto;">
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h5 class="fw-bold mb-0">Video Details</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-dark" onclick="toggleExpand()" id="expBtn">ì „ì²´í™”ë©´</button>
                            <button class="btn-close ms-2" onclick="closeDetail()"></button>
                        </div>
                    </div>
                    <div id="detailContent"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="profilePage" class="page container mt-5" style="max-width: 600px;">
        <div class="card shadow-sm border-0 p-4">
            <h4 class="fw-bold mb-4">ë‚´ ê³„ì • ê´€ë¦¬</h4>
            <div class="mb-4">
                <label class="form-label text-muted small">í˜„ì¬ ë¡œê·¸ì¸ ê³„ì • (ë³€ê²½ ë¶ˆê°€)</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="16"></span>
                    <input type="text" id="profileEmail" class="form-control bg-light" readonly>
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label fw-bold">YouTube Data API Key</label>
                <div class="input-group mb-2">
                    <input type="password" id="userApiKey" class="form-control" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <button class="btn btn-outline-dark" onclick="window.open('https://console.cloud.google.com/apis/credentials')">í‚¤ ë°œê¸‰ì†Œ</button>
                </div>
                <div id="apiKeyStatus" class="form-text text-danger">âš ï¸ ë¶„ì„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.</div>
            </div>
            <button id="saveBtn" class="btn btn-dark w-100 fw-bold py-2 mb-4" onclick="saveUserData()">ì„¤ì • ì €ì¥í•˜ê¸°</button>
            <hr>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteMyAccount()">ê³„ì • íƒˆí‡´</button>
        </div>
    </div>

    <div id="adminPage" class="container mt-4 page overflow-auto">
    <div class="row mb-4 text-center">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm py-3 bg-primary text-white">
                <h6 class="mb-1 opacity-75 small">ì´ ê°€ì…ì</h6>
                <h3 class="fw-bold mb-0" id="totalUserCount">0</h3>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm py-3 bg-success text-white">
                <h6 class="mb-1 opacity-75 small">ëˆ„ì  ê²€ìƒ‰</h6>
                <h3 class="fw-bold mb-0" id="totalSearchCount">0</h3>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm py-3">
                <h6 class="text-muted mb-1 small">í‰ê·  ë¨¸ë¬´ëŠ” ì‹œê°„</h6>
                <h3 class="fw-bold mb-0" id="avgSessionTime">12ë¶„ 45ì´ˆ</h3>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3"><h6 class="fw-bold mb-0">ğŸ”¥ ì¸ê¸° í‚¤ì›Œë“œ TOP 10 (ìµœê·¼ 1ê°œì›”)</h6></div>
                <div class="card-body"><ul id="topKeywordList" class="list-group list-group-flush small"></ul></div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3"><h6 class="fw-bold mb-0">ğŸ“ˆ ìœ ì… ê²½ë¡œ ë¶„ì„</h6></div>
                <div class="card-body" id="surveyStatList"></div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3"><h5 class="fw-bold mb-0">ğŸ‘¥ ê°€ì…ì ëª…ë‹¨ ê´€ë¦¬</h5></div>
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="px-4">ì´ë©”ì¼</th>
                        <th>ìœ ì… ê²½ë¡œ</th>
                        <th>ê°€ì…ì¼</th>
                        <th>í‰ê·  ì²´ë¥˜</th>
                        <th>ê¶Œí•œ</th>
                        <th class="text-end px-4">ê´€ë¦¬</th> 
                    </tr>
                </thead>
                <tbody id="adminUserList"></tbody>
            </table>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="fw-bold mb-0">ğŸ” ìµœê·¼ ê²€ìƒ‰ ê¸°ë¡</h5>
        </div>
        <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="px-4">ì‚¬ìš©ì</th>
                        <th>ê²€ìƒ‰ì–´</th>
                        <th>ì¼ì‹œ</th>
                    </tr>
                </thead>
                <tbody id="adminSearchList"></tbody>
            </table>
        </div>
    </div>
</div>

    <div class="modal fade" id="tagModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">íƒœê·¸</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea id="tagArea" class="form-control" rows="10" readonly></textarea></div></div></div></div>
    <div class="modal fade" id="surveyModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body p-5 text-center">
                    <h3 class="fw-bold mb-4">ì–´ë–»ê²Œ ì˜¤ì…¨ë‚˜ìš”?</h3>
                    <p class="text-muted">ì„œë¹„ìŠ¤ ê°œì„ ì„ ìœ„í•´ ìœ ì… ê²½ë¡œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-outline-dark py-3" onclick="submitSurvey('ìœ íŠœë¸Œ ê´‘ê³ /ì˜ìƒ')">ìœ íŠœë¸Œ ê´‘ê³ /ì˜ìƒ</button>
                        <button class="btn btn-outline-dark py-3" onclick="submitSurvey('ë„¤ì´ë²„ ë¸”ë¡œê·¸/ì¹´í˜')">ë„¤ì´ë²„ ë¸”ë¡œê·¸/ì¹´í˜</button>
                        <button class="btn btn-outline-dark py-3" onclick="submitSurvey('ì§€ì¸ ì¶”ì²œ')">ì§€ì¸ ì¶”ì²œ</button>
                        <button class="btn btn-outline-dark py-3" onclick="submitSurvey('ê¸°íƒ€', event)">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
            

        const firebaseConfig = {
            apiKey: "AIzaSyAv4QyHd-Gxv59DMBL2RvEJJ4fmmhcP-H4",
            authDomain: "trim-29b2c.firebaseapp.com",
            projectId: "trim-29b2c",
            storageBucket: "trim-29b2c.firebasestorage.app",
            messagingSenderId: "96358882959",
            appId: "1:96358882959:web:736c6dc63a19de94031afa",
            measurementId: "G-Z4VSQ6SYQN"
        }; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let dataTable, currentUser, savedApiKey = "";
        const CATEGORY_MAP = {'1':'ì˜í™”/ì• ë‹ˆ','2':'ìë™ì°¨','10':'ìŒì•…','15':'ë™ë¬¼','17':'ìŠ¤í¬ì¸ ','19':'ì—¬í–‰','20':'ê²Œì„','22':'ì¼ìƒ','23':'ì½”ë¯¸ë””','24':'ì—”í„°','25':'ë‰´ìŠ¤','26':'ë…¸í•˜ìš°','27':'êµìœ¡','28':'ê³¼í•™','29':'ì‚¬íšŒ'};

        window.login = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => location.reload());

        // [ìˆ˜ì •] í˜ì´ì§€ ì „í™˜ í•¨ìˆ˜ ë³´ê°•
        window.showPage = (id, saveHistory = true) => {
            $('.page').hide().removeClass('active'); 
            $('#' + id).show().addClass('active');

            if(id === 'analyzerPage') {
                window.closeDetail();
                if (dataTable) dataTable.columns.adjust();
            }

            if (saveHistory) {
                history.pushState({ pageId: id }, null, "#" + id);
            }
        };

        window.loadAdmin = async () => {
            window.showPage('adminPage', true); 
            try {
                // [ìˆ˜ì •] aSnap(admins ì»¬ë ‰ì…˜)ì„ ì¶”ê°€ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const [uSnap, sSnap, aSnap] = await Promise.all([
                    getDocs(collection(db, "users")),
                    getDocs(collection(db, "searchLogs")),
                    getDocs(collection(db, "admins"))
                ]);
                
                $('#totalUserCount').text(uSnap.size);
                $('#totalSearchCount').text(sSnap.size);

                // ê´€ë¦¬ì ì´ë©”ì¼ ëª©ë¡ì„ Setìœ¼ë¡œ ë§Œë“¤ì–´ ë¹„êµí•˜ê¸° ì‰½ê²Œ ì¤€ë¹„
                const adminEmails = new Set();
                aSnap.forEach(doc => adminEmails.add(doc.id.toLowerCase()));

                // 1. í‚¤ì›Œë“œ & ìœ ì…ê²½ë¡œ ë¶„ì„ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                const keywordCounts = {};
                const surveyCounts = {};

                sSnap.forEach(d => {
                    const data = d.data();
                    if (data.time?.toDate() > oneMonthAgo) {
                        const k = data.keyword || "ë¯¸ë¶„ë¥˜";
                        keywordCounts[k] = (keywordCounts[k] || 0) + 1;
                    }
                });
                uSnap.forEach(d => { 
                    const s = d.data().survey || "ë¯¸ì‘ë‹µ"; 
                    surveyCounts[s] = (surveyCounts[s] || 0) + 1; 
                });

                const topK = Object.entries(keywordCounts).sort((a,b) => b[1]-a[1]).slice(0, 10);
                $('#topKeywordList').html(topK.map(([k, v], i) => `
                    <li class="list-group-item d-flex justify-content-between border-0 px-0">
                        <span>${i+1}. ${k}</span><span class="badge bg-primary rounded-pill">${v}</span>
                    </li>`).join('') || "ë°ì´í„° ì—†ìŒ");
                
                $('#surveyStatList').html(Object.entries(surveyCounts).map(([source, count]) => {
                    let percent = Math.round((count / uSnap.size) * 100);
                    return `<div class="mb-2 small">${source} (${percent}%)<div class="progress" style="height:5px;"><div class="progress-bar bg-success" style="width:${percent}%"></div></div></div>`;
                }).join(''));

                // 2. ê°€ì…ì ëª…ë‹¨ ë Œë”ë§ (ìƒíƒœ íŒë³„ ë¡œì§ ì¶”ê°€)
                let uHtml = "";
                const now = new Date(); // í˜„ì¬ ì‹œê°„ ê¸°ì¤€

                uSnap.forEach(d => {
                    const data = d.data();
                    const email = data.email.toLowerCase();
                    const isWithdrawn = data.status === "withdrawn";
                    const isAdmin = adminEmails.has(email);

                    // [ìˆ˜ì • ë¶€ë¶„] ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ë™ê·¸ë¼ë¯¸ ìƒ‰ìƒ íŒë³„
                    let dotColor = "#adb5bd"; // ê¸°ë³¸ ì˜¤í”„ë¼ì¸ (ê·¸ë ˆì´)
                    if (!isWithdrawn && data.lastActive) {
                        const lastActive = data.lastActive.toDate();
                        const diff = (now - lastActive) / 1000 / 60; 
                        if (diff < 2) { 
                            dotColor = "#198754"; // ì˜¨ë¼ì¸ (ì´ˆë¡ìƒ‰)
                        }
                    }
                    
                    // íƒˆí‡´ìê°€ ì•„ë‹ ë•Œë§Œ ë™ê·¸ë¼ë¯¸ í‘œì‹œ
                    const statusDot = isWithdrawn ? "" : `<span style="display:inline-block; width:10px; height:10px; background-color:${dotColor}; border-radius:50%; margin-right:8px;"></span>`;

                    // ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 'ë¶„ì„ ëŒ€ê¸°'ë¡œ í‘œì‹œ
                    const sessionTime = isWithdrawn ? "-" : (data.lastSessionTime || "ë¶„ì„ ëŒ€ê¸°");

                    // ê¶Œí•œ ë“œë¡­ë‹¤ìš´ ìƒì„±
                    const roleSelect = `
                        <select class="form-select form-select-sm fw-bold ${isAdmin ? 'text-primary border-primary' : 'text-secondary'}" 
                                onchange="changeRole('${data.email}', this.value)" 
                                ${isWithdrawn ? 'disabled' : ''}>
                            <option value="user" ${!isAdmin ? 'selected' : ''}>ì¼ë°˜</option>
                            <option value="admin" ${isAdmin ? 'selected' : ''}>ê´€ë¦¬ì</option>
                        </select>
                    `;

                    uHtml += `
                        <tr ${isWithdrawn ? 'class="table-danger" style="opacity:0.7"' : ''}>
                            <td class="px-4">
                                ${statusDot}<b>${data.email}</b> 
                                ${isWithdrawn ? '<span class="badge bg-danger ms-1">íƒˆí‡´</span>' : ''}
                            </td>
                            <td><span class="badge bg-light text-dark border">${data.survey || 'ë¯¸ì‘ë‹µ'}</span></td>
                            <td>${data.joinedAt?.toDate().toLocaleDateString() || '-'}</td>
                            <td>${sessionTime}</td>
                            <td style="width:120px;">${roleSelect}</td> 
                            <td class="text-end px-4">
                                <button class="btn btn-sm btn-outline-danger fw-bold ms-1" onclick="deleteUserAccount('${d.id}')">ì‚­ì œ</button>
                            </td>
                        </tr>`;
                });
                $('#adminUserList').html(uHtml);

                // 3. ìµœê·¼ ê²€ìƒ‰ ê¸°ë¡ ë Œë”ë§ (ê¸°ì¡´ ìœ ì§€)
                let sHtml = "";
                const sortedLogs = sSnap.docs.map(d => d.data()).sort((a,b) => b.time?.toMillis() - a.time?.toMillis()).slice(0, 50);
                sortedLogs.forEach(log => {
                    sHtml += `<tr><td class="px-4 small text-muted">${log.user}</td><td class="fw-bold">${log.keyword}</td><td class="small text-muted">${log.time?.toDate().toLocaleString() || '-'}</td></tr>`;
                });
                $('#adminSearchList').html(sHtml);

            } catch (e) { console.error(e); alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); }
        };

        window.changeRole = async (email, newRole) => {
            const targetEmail = email.toLowerCase();
            try {
                if (newRole === "admin") {
                    // ê´€ë¦¬ì ì¶”ê°€
                    await setDoc(doc(db, "admins", targetEmail), { 
                        addedAt: serverTimestamp(),
                        addedBy: currentUser.email 
                    });
                    alert(`${email}ë‹˜ì—ê²Œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í–ˆìŠµë‹ˆë‹¤.`);
                } else {
                    // ê´€ë¦¬ì ì œê±° (ê°•ë“±)
                    if (targetEmail === "kangdaxom@gmail.com") { // ìµœê³  ê´€ë¦¬ì ë³´í˜¸
                        alert("ìµœê³  ê´€ë¦¬ì ê¶Œí•œì€ í•´ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return loadAdmin();
                    }
                    await deleteDoc(doc(db, "admins", targetEmail));
                    alert(`${email}ë‹˜ì„ ì¼ë°˜ ìœ ì €ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`);
                }
                loadAdmin(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
            } catch (e) {
                alert("ê¶Œí•œ ë³€ê²½ ì‹¤íŒ¨: " + e.message);
                loadAdmin();
            }
        };

        // ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬
        window.promoteAdmin = async (email) => {
            if (confirm(`${email}ë‹˜ì—ê²Œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                try {
                    await setDoc(doc(db, "admins", email.toLowerCase()), { addedAt: serverTimestamp() });
                    alert("ê´€ë¦¬ì ë“±ë¡ ì™„ë£Œ!");
                    loadAdmin();
                } catch (e) { alert("ê¶Œí•œ ë¶€ì—¬ ì‹¤íŒ¨"); }
            }
        };

        // ê³„ì • ì™„ì „ ì‚­ì œ
        window.deleteUserAccount = async (uid) => {
            if (confirm("ì´ ìœ ì €ì˜ ë°ì´í„°ë¥¼ DBì—ì„œ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
                try {
                    await deleteDoc(doc(db, "users", uid));
                    alert("ì‚­ì œ ì™„ë£Œ!");
                    loadAdmin();
                } catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨"); }
            }
        };

        // [í†µí•©] ì„¤ë¬¸ ì €ì¥ í•¨ìˆ˜ (ê¸°íƒ€ ì…ë ¥ ë¡œì§ í¬í•¨)
        window.submitSurvey = async (v) => {
            let finalValue = v;
            if (v === 'ê¸°íƒ€') {
                const userInput = prompt("ìœ ì… ê²½ë¡œë¥¼ ì§ì ‘ ì…ë ¥í•´ ì£¼ì„¸ìš”:");
                if (userInput === null) return; 
                if (userInput.trim() === "") {
                    alert("ì…ë ¥ê°’ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    return;
                }
                finalValue = `ê¸°íƒ€(${userInput.trim()})`;
            }

            try {
                await setDoc(doc(db, "users", currentUser.uid), { 
                    email: currentUser.email, 
                    survey: finalValue,
                    apiKey: "", 
                    status: "active",
                    joinedAt: serverTimestamp() 
                });
                
                const modalElement = document.getElementById('surveyModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) modalInstance.hide();
                
                alert("ê°ì‚¬í•©ë‹ˆë‹¤! ì„¤ì • í˜ì´ì§€ì—ì„œ API í‚¤ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.");
                window.showPage('profilePage');
            } catch (e) {
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };

        window.addAdmin = async () => {
            const email = $('#newAdminEmail').val().trim().toLowerCase();
            if(!email) return;
            await setDoc(doc(db, "admins", email), { addedAt: serverTimestamp() });
            $('#newAdminEmail').val(''); loadAdmin();
        };

        window.removeAdmin = async (email) => {
            if(email === "kangdaxom@gmail.com") return alert("ì‚­ì œ ë¶ˆê°€");
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await deleteDoc(doc(db, "admins", email)); loadAdmin(); }
        };

        // [ìˆ˜ì •] ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¡œì§ - ì¼ë°˜ ìœ ì € íŠ•ê¹€ ë°©ì§€ ë²„ì „
        onAuthStateChanged(auth, async (user) => {
            // [ìˆ˜ì •] ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ê°€ë¦¼ë§‰ì€ ì¼ë‹¨ ìˆ¨ê²¨ì„œ ë©”ì¸ í™”ë©´ì´ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
            $('#loginOverlay').hide();

            if (user) {
                currentUser = user;
                const hash = location.hash.replace('#', '');
                
                // 1. ìœ ì € ì •ë³´ í™•ì¸ (ì¼ë°˜ ìœ ì €ë„ ìê¸° ë°ì´í„°ëŠ” ì½ì„ ìˆ˜ ìˆìŒ)
                const userDoc = await getDoc(doc(db, "users", user.uid));

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // 1. íƒˆí‡´ ìœ ì € ì²˜ë¦¬ (ë³µêµ¬ ì œì•ˆ)
                    if (userData.status === "withdrawn") {
                        if (confirm("ì´ì „ì— íƒˆí‡´í•˜ì‹  ê³„ì •ì…ë‹ˆë‹¤. ê³„ì •ì„ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                            await updateDoc(doc(db, "users", user.uid), { 
                                status: "active",
                                joinedAt: serverTimestamp(), 
                                apiKey: "" 
                            });
                            alert("ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
                            location.reload(); 
                            return;
                        } else {
                            await signOut(auth);
                            location.reload();
                            return;
                        }
                    }

                    // 2. ê¸°ì¡´ ìœ ì € ì •ë³´ ë¡œë“œ
                    savedApiKey = userData.apiKey || "";
                    $('#userApiKey').val(savedApiKey);
                    if(savedApiKey) $('#apiKeyStatus').html("<span class='text-success'>âœ… API í‚¤ ë“±ë¡ë¨</span>");
                    
                } else {
                    // ì‹ ê·œ ìœ ì €: ì„¤ë¬¸ ëª¨ë‹¬ ë„ìš°ê¸°
                    if (hash !== 'profilePage') {
                        new bootstrap.Modal(document.getElementById('surveyModal')).show();
                    }
                }

                // 2. ê´€ë¦¬ì ì²´í¬
                let isAdmin = false;
                try {
                    const adminDoc = await getDoc(doc(db, "admins", user.email.toLowerCase()));
                    if (adminDoc.exists()) {
                        isAdmin = true;
                        $('#adminBtnArea').html(`<button class="btn btn-sm btn-warning fw-bold ms-2" onclick="loadAdmin()">ğŸ›  ëŒ€ì‹œë³´ë“œ</button>`);
                        if($('#adminLink').length === 0) {
                            $('#userMenu').prepend(`<li><a id="adminLink" class="dropdown-item fw-bold text-primary" href="javascript:void(0)" onclick="loadAdmin()">ğŸš€ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a></li>`);
                        }
                    }
                } catch (e) {
                    console.log("ê´€ë¦¬ì ê¶Œí•œ ì—†ìŒ (ì¼ë°˜ ìœ ì € ë¡œê·¸ì¸)");
                }

                // 3. UI í‘œì‹œ
                // [ì¶”ê°€] ë¡œê·¸ì¸ ì„±ê³µ ì‹œ: 'ë¬´ë£Œì´ìš©' ë²„íŠ¼ ìˆ¨ê¸°ê³  'í”„ë¡œí•„' ë³´ì—¬ì£¼ê¸°
                $('#guestControls').addClass('d-none');
                $('#userControls').removeClass('d-none');

                // [ì¶”ê°€] ë¡œê·¸ì¸ ìœ ë„ ëª¨ë‹¬ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ìŠµë‹ˆë‹¤.
                const loginM = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                if(loginM) loginM.hide();

                $('#navControls').removeClass('d-none');
                $('#userAvatar').attr('src', user.photoURL);
                $('#userEmailDisplay').text(user.email);
                $('#profileEmail').val(user.email);

                // í˜ì´ì§€ ê²°ì •
                if (hash === 'profilePage') {
                    window.showPage('profilePage', false);
                } else if (hash === 'adminPage' && isAdmin) {
                    window.loadAdmin();
                } else {
                    window.showPage('analyzerPage', false);
                }
            } else {
                // [ì¶”ê°€] ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¼ ë•Œ ì²˜ë¦¬
                currentUser = null;
                // [ì¶”ê°€] ë¡œê·¸ì•„ì›ƒ ì‹œ: 'ë¬´ë£Œì´ìš©' ë²„íŠ¼ ë³´ì—¬ì£¼ê³  'í”„ë¡œí•„' ìˆ¨ê¸°ê¸°
                $('#guestControls').removeClass('d-none');
                $('#userControls').addClass('d-none');
                
                $('#navControls').removeClass('d-none'); // ë²„íŠ¼ì€ ë³´ì—¬ì•¼ í•˜ë¯€ë¡œ d-none ì œê±°
            }
        });

        // ë¶„ì„ ë¡œì§ ë° ë‚˜ë¨¸ì§€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼)
        $('#searchBtn').click(async function() {// 1. ë¡œê·¸ì¸ ì—¬ë¶€ ì²´í¬
            if (!currentUser) {
                new bootstrap.Modal(document.getElementById('loginModal')).show();
                return;
            }

            // 2. API KEY ì²´í¬
            if (!savedApiKey) { 
                alert("API KEY ë“±ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤."); 
                return window.showPage('profilePage'); 
            }
            if (!savedApiKey) { alert("API KEY ë“±ë¡ í•„ìš”"); return window.showPage('profilePage'); }
            const queryText = $('#query').val();
            if (!queryText) return;
            
            try { await addDoc(collection(db, "searchLogs"), { user: currentUser.email, keyword: queryText, time: serverTimestamp() }); } catch(e) {}
            
            $('#status').html('ë¶„ì„ ì¤‘...');
            dataTable.clear().draw();

            try {
                const minV = parseInt($('#minViews').val()) || 0;
                const typeFilter = $('#videoType').val();
                const durMax = parseInt($('#durationMax').val()) || 20;
                const months = $('#monthsAgo').val();
                let dateParam = '';
                if (months !== 'all') {
                    const date = new Date(); date.setMonth(date.getMonth() - parseInt(months));
                    dateParam = `&publishedAfter=${date.toISOString()}`;
                }

                let results = [];
                let nextToken = '';
                for(let i=0; i<5; i++){
                    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(queryText)}&type=video${dateParam}${nextToken ? '&pageToken='+nextToken : ''}&maxResults=50&order=viewCount&regionCode=KR&key=${savedApiKey}`);
                    const data = await res.json();
                    if(!data.items) break;

                    const vIds = data.items.map(v => v.id.videoId).join(',');
                    const vRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${vIds}&key=${savedApiKey}`);
                    const vData = await vRes.json();
                    
                    const cIds = [...new Set(vData.items.map(v => v.snippet.channelId))].join(',');
                    const cRes = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${cIds}&key=${savedApiKey}`);
                    const cData = await cRes.json();
                    const cMap = {}; cData.items.forEach(c => cMap[c.id] = c.statistics.subscriberCount);

                    vData.items.forEach(v => {
                        const views = parseInt(v.statistics.viewCount);
                        const sec = parseDurationToSec(v.contentDetails.duration);
                        let pass = (views >= minV);
                        if(typeFilter === 'long_form') pass = pass && (sec >= 180 && sec <= durMax*60);
                        if(typeFilter === 'short_form') pass = pass && (sec < 60);
                        if(pass && results.length < 30) {
                            const s = v.snippet; const t = v.statistics;
                            const hr = s.thumbnails.maxres ? s.thumbnails.maxres.url : s.thumbnails.medium.url;
                            results.push([ results.length+1, `<img src="${s.thumbnails.default.url}" data-highres="${hr}" class="thumb-img rounded" style="width:50px;">`, s.title, new Date(s.publishedAt).toLocaleDateString(), new Date(s.publishedAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), views.toLocaleString(), parseInt(t.likeCount||0).toLocaleString(), parseInt(t.commentCount||0).toLocaleString(), CATEGORY_MAP[s.categoryId]||'ê¸°íƒ€', s.channelTitle, cMap[s.channelId]?parseInt(cMap[s.channelId]).toLocaleString():'ë¹„ê³µê°œ', `<span class="tag-badge" onclick="openTagModal('${s.tags?.join(',') || ''}')">íƒœê·¸</span>`, s.description, `<a href="https://youtu.be/${v.id}" target="_blank">Link</a>`, formatDuration(v.contentDetails.duration) ]);
                        }
                    });
                    nextToken = data.nextPageToken;
                    if(!nextToken || results.length >= 30) break;
                }
                dataTable.rows.add(results).draw();
                $('#status').text(`ë¶„ì„ ì™„ë£Œ: ${results.length}ê±´`);
            } catch(e) { $('#status').text("ì˜¤ë¥˜ ë°œìƒ"); }
        });

        window.saveUserData = async () => {
            const key = $('#userApiKey').val();
            await updateDoc(doc(db, "users", currentUser.uid), { apiKey: key });
            savedApiKey = key; alert("ì €ì¥ ì™„ë£Œ!"); window.showPage('analyzerPage');
        };

        // [ì¶”ê°€] í•„í„° ì¡°ê±´ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ëŠ” í•¨ìˆ˜
        window.resetToCustomDefaults = () => {
            // 1. ê° í•„ë“œ ê°’ì„ ê¸°ë³¸ ì„¤ì •ê°’ìœ¼ë¡œ ë³€ê²½
            $('#minViews').val(30000);
            $('#monthsAgo').val("6");
            $('#videoType').val("long_form");
            $('#durationMax').val(20);
            
            // 2. ê²€ìƒ‰ì–´ì°½ê¹Œì§€ ì´ˆê¸°í™”í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
            // $('#query').val("");

            // 3. UI ì—…ë°ì´íŠ¸ (ì‡¼ì¸  ëª¨ë“œì˜€ë‹¤ë©´ ë‹¤ì‹œ ë¡±í¼ ì„¤ì •ì°½ì„ ë³´ì—¬ì¤˜ì•¼ í•¨)
            window.toggleTypeDetail();

            console.log("í•„í„° ê¸°ë³¸ê°’ ì ìš© ì™„ë£Œ");
        };

        function parseDurationToSec(d) {
            const m = d.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            return (parseInt(m[1])||0)*3600 + (parseInt(m[2])||0)*60 + (parseInt(m[3])||0);
        }

        function formatDuration(d) {
            const m = d.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            return `${m[1]?m[1]+':':''}${(m[2]||'0').padStart(2,'0')}:${(m[3]||'0').padStart(2,'0')}`;
        }

        window.closeDetail = () => { $('#detailPanel').removeClass('open expanded'); $('#ytTable tbody tr').removeClass('selected-row'); };
        window.toggleExpand = () => { $('#detailPanel').toggleClass('expanded'); $('#expBtn').text($('#detailPanel').hasClass('expanded') ? 'ì¶•ì†Œ' : 'ì „ì²´'); };
        window.openTagModal = (s) => { $('#tagArea').val(s); new bootstrap.Modal(document.getElementById('tagModal')).show(); };
        window.toggleTypeDetail = () => { document.getElementById('typeDetailContainer').style.visibility = ($('#videoType').val() === 'long_form') ? 'visible' : 'hidden'; };

        $(document).ready(function() {
            dataTable = $('#ytTable').DataTable({ paging: true, pageLength: 50, scrollX: true });
            $(document).on('click', '#ytTable tbody tr', function(e) {
                if($(e.target).closest('button, a, .tag-badge').length) return;
                $('#ytTable tbody tr').removeClass('selected-row'); $(this).addClass('selected-row');
                const rowData = dataTable.row(this).data();
                if(rowData) {
                    $('#detailContent').html(`<img src="${$(rowData[1]).data('highres')}" class="img-fluid rounded mb-3"><h5 class="fw-bold">${rowData[2]}</h5><div class="bg-light p-3 small border rounded" style="max-height:300px; overflow-y:auto; white-space:pre-wrap;">${rowData[12]}</div><a href="${$(rowData[13]).attr('href')}" target="_blank" class="btn btn-dark w-100 mt-3">ì˜ìƒ ì—´ê¸°</a>`);
                    $('#detailPanel').addClass('open');
                }
            });
            $(document).on('mouseenter', '.thumb-img', function(e) { $('#hoverPreview').attr('src', $(this).data('highres')).show(); })
            .on('mousemove', '.thumb-img', function(e) { $('#hoverPreview').css({ top: e.clientY + 15, left: e.clientX + 15 }); })
            .on('mouseleave', '.thumb-img', function() { $('#hoverPreview').hide(); });
        });

        window.onpopstate = function(event) {
            if (event.state && event.state.pageId) {
                window.showPage(event.state.pageId, false);
            } else {
                window.showPage('analyzerPage', false);
            }
        };

        window.deleteMyAccount = async () => {
            if (!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në°ì´í„°ëŠ” ì •ì±…ì— ë”°ë¼ 1ë…„ê°„ ë³´ê´€ í›„ ì‚­ì œë©ë‹ˆë‹¤.")) return;

            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, {
                    status: "withdrawn",
                    deletedAt: serverTimestamp(),
                    apiKey: "" 
                });

                alert("íƒˆí‡´ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                await signOut(auth);
                location.reload(); 
            } catch (e) {
                alert("íƒˆí‡´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };


        // ìœ ì € ì ‘ì† ì‹œì  ê¸°ë¡
        let startTime = Date.now();

        // ìœ ì €ê°€ í˜ì´ì§€ë¥¼ ë– ë‚˜ê±°ë‚˜ íƒ­ì„ ê°€ë¦´ ë•Œ ì‹œê°„ ê¸°ë¡
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'hidden' && currentUser) {
                const endTime = Date.now();
                const durationMinutes = Math.round((endTime - startTime) / 1000 / 60);
                
                // 1ë¶„ ì´ìƒ ë¨¸ë¬¼ë €ì„ ë•Œë§Œ ê¸°ë¡ ì—…ë°ì´íŠ¸
                if (durationMinutes > 0) {
                    try {
                        const userRef = doc(db, "users", currentUser.uid);
                        await updateDoc(userRef, {
                            lastSessionTime: durationMinutes + "ë¶„",
                            totalTime: increment(durationMinutes) // ì „ì²´ ëˆ„ì  ì‹œê°„ í•©ì‚°
                        });
                    } catch (e) {
                        console.error("ì²´ë¥˜ì‹œê°„ ê¸°ë¡ ì‹¤íŒ¨:", e);
                    }
                }
            }
        });

        // ìœ ì € í™œë™ ì‹ í˜¸ ì£¼ê¸°ì  ì „ì†¡ (30ì´ˆë§ˆë‹¤)
        setInterval(async () => {
            if (currentUser) {
                try {
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, {
                        lastActive: serverTimestamp()
                    });
                } catch (e) { console.error("í™œë™ ì‹ í˜¸ ì „ì†¡ ì‹¤íŒ¨"); }
            }
        }, 30000);
    </script>
</body>
</html>
