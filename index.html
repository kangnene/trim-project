<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trim</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        body { height: 100vh; overflow: hidden; background-color: #f1f3f5; }
        .page { display: none; height: calc(100vh - 56px); overflow: hidden; }
        .page.active { display: block; }
        .navbar { background: #212529 !important; border-bottom: 2px solid #343a40 !important; }
        .navbar-brand { color: #ffffff !important; }
        .filter-bar { background: #ffffff !important; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table { font-size: 0.75rem !important; }
        #ytTable td { max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .selected-row { background-color: #e9ecef !important; font-weight: bold; }
        #detailPanel { transition: width 0.3s ease; width: 0; overflow-x: hidden; background: #fff; z-index: 1000; }
        #detailPanel.open { width: 450px; border-left: 1px solid #dee2e6; }
        #detailPanel.expanded { width: 100% !important; }
        .thumb-preview { position: fixed; z-index: 9999; pointer-events: none; display: none; max-width: 320px; border: 2px solid #fff; }
        .tag-badge { cursor: pointer; text-decoration: underline; color: #0d6efd; }
        .search-label { font-weight: bold; font-size: 10px; color: #6c757d; display: block; text-transform: uppercase; }
        .avatar-btn { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 1px solid #ddd; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .cursor-pointer { cursor: pointer; }
        .badge .remove-btn { margin-left: 8px; padding: 0 4px; border-radius: 50%; background: rgba(255,255,255,0.2); transition: background 0.2s; }
        .badge .remove-btn:hover { background: #ff4757; color: white; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h2 class="fw-bold mb-4">Trim - YouTube Analyzer</h2>
        <p class="text-muted mb-4">ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        <button class="btn btn-dark btn-lg px-5 shadow" onclick="login()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" class="me-2"> êµ¬ê¸€ë¡œ ì‹œì‘í•˜ê¸°
        </button>
    </div>

    <img id="hoverPreview" class="thumb-preview rounded shadow" src="">

    <nav class="navbar navbar-expand-lg py-1 shadow-sm">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <a class="navbar-brand fw-bold me-2" href="#" onclick="showPage('analyzerPage')">TRIM</a>
                <div id="adminBtnArea"></div>
            </div>
            
            <div id="navControls" class="d-flex align-items-center gap-2 flex-grow-1 d-none">
                <div class="me-auto"></div> 
                <div class="dropdown">
                    <img id="userAvatar" class="avatar-btn dropdown-toggle" data-bs-toggle="dropdown" src="">
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0" id="userMenu">
                        <li><h6 class="dropdown-header" id="userEmailDisplay">ì´ë©”ì¼</h6></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="showPage('profilePage')">ë‚´ ê³„ì • ê´€ë¦¬</a></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div id="analyzerPage" class="page active">
        <div class="filter-bar p-2 px-3 d-flex align-items-center gap-3 flex-wrap">
            <div>
                <label class="search-label">MIN VIEWS</label>
                <input type="number" id="minViews" class="form-control form-control-sm fw-bold text-center" style="width:90px;" value="30000">
            </div>
            <div>
                <label class="search-label">PERIOD</label>
                <select id="monthsAgo" class="form-select form-select-sm">
                    <option value="all">ì „ì²´</option>
                    <option value="1">1ê°œì›”</option>
                    <option value="6" selected>6ê°œì›”</option>
                    <option value="12">1ë…„</option>
                </select>
            </div>
            <div>
                <label class="search-label">TYPE</label>
                <select id="videoType" class="form-select form-select-sm" onchange="toggleTypeDetail()">
                    <option value="any">ì „ì²´</option>
                    <option value="long_form" selected>ë¡±í¼(3ë¶„~)</option>
                    <option value="short_form">ì‡¼ì¸ </option>
                </select>
            </div>
            <div id="typeDetailContainer">
                <label class="search-label">MAX DURATION (ë¶„ ì´í•˜)</label>
                <div class="input-group input-group-sm">
                    <input type="number" id="durationMax" class="form-control" style="width:60px;" value="20">
                    <span class="input-group-text">ë¶„ ì´í•˜</span>
                </div>
            </div>
            <div class="ms-auto d-flex align-items-center gap-2">
                <input type="text" id="query" class="form-control form-control-sm bg-light" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" style="width: 200px;">
                <button id="searchBtn" class="btn btn-dark btn-sm px-4 fw-bold">ë¶„ì„ ì‹œì‘</button>
            </div>
        </div>

        <div class="d-flex h-100 overflow-hidden">
            <div class="flex-grow-1 overflow-auto p-3">
                <table id="ytTable" class="table table-hover table-sm align-middle w-100">
                    <thead class="table-light">
                        <tr>
                            <th>#</th><th>ì¸ë„¤ì¼</th><th>ì˜ìƒì œëª©</th><th>ë‚ ì§œ</th><th>ì‹œê°„</th><th class="text-end">ì¡°íšŒìˆ˜</th><th class="text-end">ì¢‹ì•„ìš”</th><th class="text-end">ëŒ“ê¸€</th><th>ì¹´í…Œê³ ë¦¬</th><th>ì±„ë„ëª…</th><th class="text-end">êµ¬ë…ì</th><th>íƒœê·¸</th><th>ì„¤ëª…</th><th>ë§í¬</th><th>ê¸¸ì´</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
                <div id="status" class="py-3 text-center text-muted">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
            </div>

            <div id="detailPanel" class="shadow-lg d-flex flex-column">
                <div class="p-4 w-100 d-flex flex-column h-100" style="overflow-y: auto;">
                    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                        <h5 class="fw-bold mb-0">Video Details</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-dark" onclick="toggleExpand()" id="expBtn">ì „ì²´í™”ë©´</button>
                            <button class="btn-close ms-2" onclick="closeDetail()"></button>
                        </div>
                    </div>
                    <div id="detailContent"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="profilePage" class="page container mt-5" style="max-width: 600px;">
        <div class="card shadow-sm border-0 p-4">
            <h4 class="fw-bold mb-4">ë‚´ ê³„ì • ê´€ë¦¬</h4>
            <div class="mb-4">
                <label class="form-label text-muted small">í˜„ì¬ ë¡œê·¸ì¸ ê³„ì • (ë³€ê²½ ë¶ˆê°€)</label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="16"></span>
                    <input type="text" id="profileEmail" class="form-control bg-light" readonly>
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label fw-bold">YouTube Data API Key</label>
                <div class="input-group mb-2">
                    <input type="password" id="userApiKey" class="form-control" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <button class="btn btn-outline-dark" onclick="window.open('https://console.cloud.google.com/apis/credentials')">í‚¤ ë°œê¸‰ì†Œ</button>
                </div>
                <div id="apiKeyStatus" class="form-text text-danger">âš ï¸ ë¶„ì„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.</div>
            </div>
            <button id="saveBtn" class="btn btn-dark w-100 fw-bold py-2 mb-4" onclick="saveUserData()">ì„¤ì • ì €ì¥í•˜ê¸°</button>
            <hr>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteMyAccount()">ê³„ì • íƒˆí‡´</button>
        </div>
    </div>

    <div id="adminPage" class="container mt-4 page overflow-auto">
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card bg-primary text-white border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h6 class="text-uppercase mb-2" style="font-size: 0.8rem; opacity: 0.8;">ì´ ê°€ì…ì ìˆ˜</h6>
                        <h2 class="display-6 fw-bold mb-0" id="totalUserCount">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card bg-success text-white border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h6 class="text-uppercase mb-2" style="font-size: 0.8rem; opacity: 0.8;">ëˆ„ì  ê²€ìƒ‰ ê±´ìˆ˜</h6>
                        <h2 class="display-6 fw-bold mb-0" id="totalSearchCount">0</h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="card-title fw-bold mb-0">ğŸ”‘ ê´€ë¦¬ì ê¶Œí•œ ì„¤ì •</h5>
            </div>
            <div class="card-body">
                <div class="input-group mb-3" style="max-width: 500px;">
                    <input type="email" id="newAdminEmail" class="form-control" placeholder="ì´ë©”ì¼ ì…ë ¥">
                    <button class="btn btn-primary" onclick="addAdmin()">ê´€ë¦¬ì ì¶”ê°€</button>
                </div>
                <div id="adminBadgeList" class="d-flex flex-wrap gap-2"></div>
            </div>
        </div>
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3"><h5 class="fw-bold mb-0">ğŸ‘¥ ê°€ì…ì ëª…ë‹¨</h5></div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-light"><tr><th class="px-4">ì´ë©”ì¼</th><th>ì„¤ë¬¸</th><th>ê°€ì…ì¼</th></tr></thead>
                    <tbody id="adminUserList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="tagModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">íƒœê·¸</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea id="tagArea" class="form-control" rows="10" readonly></textarea></div></div></div></div>
    <div class="modal fade" id="surveyModal" data-bs-backdrop="static" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-5 text-center"><h3>í™˜ì˜í•©ë‹ˆë‹¤!</h3><div class="d-grid gap-2 mt-4"><button class="btn btn-outline-dark py-3" onclick="submitSurvey('ìœ íŠœë¸Œ í¬ë¦¬ì—ì´í„°')">ìœ íŠœë¸Œ í¬ë¦¬ì—ì´í„°</button><button class="btn btn-outline-dark py-3" onclick="submitSurvey('ë§ˆì¼€íŒ…/ëŒ€í–‰ì‚¬')">ë§ˆì¼€íŒ…/ëŒ€í–‰ì‚¬</button><button class="btn btn-outline-dark py-3" onclick="submitSurvey('ê¸°íƒ€')">ê¸°íƒ€</button></div></div></div></div></div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAv4QyHd-Gxv59DMBL2RvEJJ4fmmhcP-H4",
            authDomain: "trim-29b2c.firebaseapp.com",
            projectId: "trim-29b2c",
            storageBucket: "trim-29b2c.firebasestorage.app",
            messagingSenderId: "96358882959",
            appId: "1:96358882959:web:736c6dc63a19de94031afa",
            measurementId: "G-Z4VSQ6SYQN"
        }; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let dataTable, currentUser, savedApiKey = "";
        const CATEGORY_MAP = {'1':'ì˜í™”/ì• ë‹ˆ','2':'ìë™ì°¨','10':'ìŒì•…','15':'ë™ë¬¼','17':'ìŠ¤í¬ì¸ ','19':'ì—¬í–‰','20':'ê²Œì„','22':'ì¼ìƒ','23':'ì½”ë¯¸ë””','24':'ì—”í„°','25':'ë‰´ìŠ¤','26':'ë…¸í•˜ìš°','27':'êµìœ¡','28':'ê³¼í•™','29':'ì‚¬íšŒ'};

        window.login = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => location.reload());

        window.showPage = (id, saveHistory = true) => {
            $('.page').removeClass('active').hide();
            $('#' + id).addClass('active').show();
            if(id === 'analyzerPage') window.closeDetail();

            // ì£¼ì†Œì°½ ë’¤ì— #idë¥¼ ë¶™ì—¬ ë¸Œë¼ìš°ì €ì— ê¸°ë¡ì„ ë‚¨ê¹ë‹ˆë‹¤.
            if (saveHistory) {
                history.pushState({ pageId: id }, null, "#" + id);
            }
        };
        // ê´€ë¦¬ì ê¸°ëŠ¥
        window.loadAdmin = async () => {
            // 1. ë¨¼ì € í˜ì´ì§€ë¥¼ ë³´ì—¬ì£¼ê³  ê¸°ë¡ì„ ë‚¨ê¹ë‹ˆë‹¤.
            window.showPage('adminPage', true); 
            
            try {
                // 2. ê·¸ ë‹¤ìŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                const [uSnap, sSnap, aSnap] = await Promise.all([
                    getDocs(collection(db, "users")),
                    getDocs(collection(db, "searchLogs")),
                    getDocs(collection(db, "admins"))
                ]);
                
                $('#totalUserCount').text(uSnap.size);
                $('#totalSearchCount').text(sSnap.size);

                let uHtml = "";
                uSnap.forEach(d => {
                    const data = d.data();
                    uHtml += `<tr><td class="px-4">${data.email}</td><td>${data.survey||'-'}</td><td>${data.joinedAt?.toDate().toLocaleDateString()||'-'}</td></tr>`;
                });
                $('#adminUserList').html(uHtml);

                let aHtml = "";
                aSnap.forEach(d => {
                    aHtml += `<div class="badge bg-dark p-2 d-flex align-items-center"><span>${d.id}</span><span class="remove-btn cursor-pointer ms-2" onclick="removeAdmin('${d.id}')">âœ•</span></div>`;
                });
                $('#adminBadgeList').html(aHtml);
                
            } catch (e) { 
                console.error("Admin Load Error:", e);
                alert("ê¶Œí•œì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); 
                window.showPage('analyzerPage', false); 
            }
        };

        window.addAdmin = async () => {
            const email = $('#newAdminEmail').val().trim().toLowerCase();
            if(!email) return;
            await setDoc(doc(db, "admins", email), { addedAt: serverTimestamp() });
            $('#newAdminEmail').val(''); loadAdmin();
        };

        window.removeAdmin = async (email) => {
            if(email === "kangdaxom@gmail.com") return alert("ì‚­ì œ ë¶ˆê°€");
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await deleteDoc(doc(db, "admins", email)); loadAdmin(); }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                $('#loginOverlay').hide();
                $('#navControls').removeClass('d-none');
                $('#userAvatar').attr('src', user.photoURL);
                $('#userEmailDisplay').text(user.email);
                $('#profileEmail').val(user.email);

                // 1. ê´€ë¦¬ì ì—¬ë¶€ ì²´í¬ ë° ë²„íŠ¼ ë…¸ì¶œ
                const adminDoc = await getDoc(doc(db, "admins", user.email.toLowerCase()));
                if (adminDoc.exists()) {
                    // ìƒë‹¨ ë²„íŠ¼ (ë¡œê³  ì˜†)
                    $('#adminBtnArea').html(`<button class="btn btn-sm btn-warning fw-bold ms-2" onclick="loadAdmin()">ğŸ›  ëŒ€ì‹œë³´ë“œ</button>`);
                    
                    // ë©”ë‰´ ë‚´ ë²„íŠ¼ (ì•„ë°”íƒ€ í´ë¦­ ì‹œ)
                    if($('#adminLink').length === 0) {
                        // href="javascript:void(0)"ë¥¼ ë„£ì–´ í˜ì´ì§€ ì´ë™ì„ ë§‰ê³  onclickë§Œ ì‹¤í–‰ë˜ê²Œ í•©ë‹ˆë‹¤.
                        $('#userMenu').prepend(`<li><a id="adminLink" class="dropdown-item fw-bold text-primary" href="javascript:void(0)" onclick="loadAdmin()">ğŸš€ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a></li>`);
                    }
                }

                // 2. ìœ ì € ì •ë³´ í™•ì¸
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (!userDoc.exists()) {
                    new bootstrap.Modal(document.getElementById('surveyModal')).show();
                } else {
                    savedApiKey = userDoc.data().apiKey || "";
                    $('#userApiKey').val(savedApiKey);
                    if(savedApiKey) $('#apiKeyStatus').html("<span class='text-success'>âœ… API í‚¤ ë“±ë¡ë¨</span>");
                }
            }
        });

        // ë¶„ì„ ë¡œì§
        $('#searchBtn').click(async function() {
            if (!savedApiKey) { alert("API KEY ë“±ë¡ í•„ìš”"); return showPage('profilePage'); }
            const queryText = $('#query').val();
            if (!queryText) return;
            
            try { await addDoc(collection(db, "searchLogs"), { user: currentUser.email, keyword: queryText, time: serverTimestamp() }); } catch(e) {}
            
            $('#status').html('ë¶„ì„ ì¤‘...');
            dataTable.clear().draw();

            try {
                const minV = parseInt($('#minViews').val()) || 0;
                const typeFilter = $('#videoType').val();
                const durMax = parseInt($('#durationMax').val()) || 20;
                const months = $('#monthsAgo').val();
                let dateParam = '';
                if (months !== 'all') {
                    const date = new Date(); date.setMonth(date.getMonth() - parseInt(months));
                    dateParam = `&publishedAfter=${date.toISOString()}`;
                }

                let results = [];
                let nextToken = '';
                for(let i=0; i<5; i++){
                    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(queryText)}&type=video${dateParam}${nextToken ? '&pageToken='+nextToken : ''}&maxResults=50&order=viewCount&regionCode=KR&key=${savedApiKey}`);
                    const data = await res.json();
                    if(!data.items) break;

                    const vIds = data.items.map(v => v.id.videoId).join(',');
                    const vRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${vIds}&key=${savedApiKey}`);
                    const vData = await vRes.json();
                    
                    const cIds = [...new Set(vData.items.map(v => v.snippet.channelId))].join(',');
                    const cRes = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${cIds}&key=${savedApiKey}`);
                    const cData = await cRes.json();
                    const cMap = {}; cData.items.forEach(c => cMap[c.id] = c.statistics.subscriberCount);

                    vData.items.forEach(v => {
                        const views = parseInt(v.statistics.viewCount);
                        const sec = parseDurationToSec(v.contentDetails.duration);
                        let pass = (views >= minV);
                        if(typeFilter === 'long_form') pass = pass && (sec >= 180 && sec <= durMax*60);
                        if(typeFilter === 'short_form') pass = pass && (sec < 60);
                        if(pass && results.length < 30) {
                            const s = v.snippet; const t = v.statistics;
                            const hr = s.thumbnails.maxres ? s.thumbnails.maxres.url : s.thumbnails.medium.url;
                            results.push([ results.length+1, `<img src="${s.thumbnails.default.url}" data-highres="${hr}" class="thumb-img rounded" style="width:50px;">`, s.title, new Date(s.publishedAt).toLocaleDateString(), new Date(s.publishedAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), views.toLocaleString(), parseInt(t.likeCount||0).toLocaleString(), parseInt(t.commentCount||0).toLocaleString(), CATEGORY_MAP[s.categoryId]||'ê¸°íƒ€', s.channelTitle, cMap[s.channelId]?parseInt(cMap[s.channelId]).toLocaleString():'ë¹„ê³µê°œ', `<span class="tag-badge" onclick="openTagModal('${s.tags?.join(',') || ''}')">íƒœê·¸</span>`, s.description, `<a href="https://youtu.be/${v.id}" target="_blank">Link</a>`, formatDuration(v.contentDetails.duration) ]);
                        }
                    });
                    nextToken = data.nextPageToken;
                    if(!nextToken || results.length >= 30) break;
                }
                dataTable.rows.add(results).draw();
                $('#status').text(`ë¶„ì„ ì™„ë£Œ: ${results.length}ê±´`);
            } catch(e) { $('#status').text("ì˜¤ë¥˜ ë°œìƒ"); }
        });

        window.saveUserData = async () => {
            const key = $('#userApiKey').val();
            await updateDoc(doc(db, "users", currentUser.uid), { apiKey: key });
            savedApiKey = key; alert("ì €ì¥ ì™„ë£Œ!"); showPage('analyzerPage');
        };

        window.submitSurvey = async (v) => {
            await setDoc(doc(db, "users", currentUser.uid), { email: currentUser.email, survey: v, apiKey: "", joinedAt: serverTimestamp() });
            bootstrap.Modal.getInstance(document.getElementById('surveyModal')).hide();
        };

        function parseDurationToSec(d) {
            const m = d.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            return (parseInt(m[1])||0)*3600 + (parseInt(m[2])||0)*60 + (parseInt(m[3])||0);
        }

        function formatDuration(d) {
            const m = d.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            return `${m[1]?m[1]+':':''}${(m[2]||'0').padStart(2,'0')}:${(m[3]||'0').padStart(2,'0')}`;
        }

        window.closeDetail = () => { $('#detailPanel').removeClass('open expanded'); $('#ytTable tbody tr').removeClass('selected-row'); };
        window.toggleExpand = () => { $('#detailPanel').toggleClass('expanded'); $('#expBtn').text($('#detailPanel').hasClass('expanded') ? 'ì¶•ì†Œ' : 'ì „ì²´'); };
        window.openTagModal = (s) => { $('#tagArea').val(s); new bootstrap.Modal(document.getElementById('tagModal')).show(); };
        window.toggleTypeDetail = () => { document.getElementById('typeDetailContainer').style.visibility = ($('#videoType').val() === 'long_form') ? 'visible' : 'hidden'; };

        $(document).ready(function() {
            dataTable = $('#ytTable').DataTable({ paging: true, pageLength: 50, scrollX: true });
            $(document).on('click', '#ytTable tbody tr', function(e) {
                if($(e.target).closest('button, a, .tag-badge').length) return;
                $('#ytTable tbody tr').removeClass('selected-row'); $(this).addClass('selected-row');
                const rowData = dataTable.row(this).data();
                if(rowData) {
                    $('#detailContent').html(`<img src="${$(rowData[1]).data('highres')}" class="img-fluid rounded mb-3"><h5 class="fw-bold">${rowData[2]}</h5><div class="bg-light p-3 small border rounded" style="max-height:300px; overflow-y:auto; white-space:pre-wrap;">${rowData[12]}</div><a href="${$(rowData[13]).attr('href')}" target="_blank" class="btn btn-dark w-100 mt-3">ì˜ìƒ ì—´ê¸°</a>`);
                    $('#detailPanel').addClass('open');
                }
            });
            $(document).on('mouseenter', '.thumb-img', function(e) { $('#hoverPreview').attr('src', $(this).data('highres')).show(); })
            .on('mousemove', '.thumb-img', function(e) { $('#hoverPreview').css({ top: e.clientY + 15, left: e.clientX + 15 }); })
            .on('mouseleave', '.thumb-img', function() { $('#hoverPreview').hide(); });
        });

        // ì‚¬ìš©ìê°€ ë§ˆìš°ìŠ¤ ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸°ë¥¼ ëˆŒë €ì„ ë•Œ ì‹¤í–‰
        window.onpopstate = function(event) {
            if (event.state && event.state.pageId) {
                // ê¸°ë¡ì— ì €ì¥ëœ í˜ì´ì§€ë¡œ ì´ë™ (ì¤‘ë³µ ê¸°ë¡ ë°©ì§€ë¥¼ ìœ„í•´ false ì‚¬ìš©)
                window.showPage(event.state.pageId, false);
            } else {
                // ê¸°ë¡ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ í˜ì´ì§€ë¡œ
                window.showPage('analyzerPage', false);
            }
        };

        // í˜ì´ì§€ ì²« ì ‘ì† ì‹œ URLì— #ì´ ìˆìœ¼ë©´ í•´ë‹¹ í˜ì´ì§€ë¥¼ ë°”ë¡œ ë„ì›Œì¤Œ
        $(window).on('load', function() {
            const hash = location.hash.replace('#', '');
            if (hash && ['adminPage', 'profilePage', 'analyzerPage'].includes(hash)) {
                setTimeout(() => window.showPage(hash, false), 500); // ë¡œê·¸ì¸ ëŒ€ê¸°ìš© 0.5ì´ˆ ì§€ì—°
            } else {
                // ì²« í˜ì´ì§€ ìƒíƒœë¥¼ ë¸Œë¼ìš°ì €ì— ë“±ë¡
                history.replaceState({ pageId: 'analyzerPage' }, null, "#analyzerPage");
            }
        });
    </script>
</body>
</html>